name: E2E
on:
    pull_request:

jobs:
    phpstan-src:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
        steps:
            -
                name: Checkout code
                uses: actions/checkout@v4
                with:
                    path: analyser

            -
                name: Clone phpstan/phpstan-src
                uses: actions/checkout@v4
                with:
                    path: phpstan
                    repository: phpstan/phpstan-src

            -
                name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.3

            -
                name: Install analyser dependencies
                working-directory: analyser
                run: composer install --no-progress --prefer-dist --no-interaction

            -
                name: Install phpstan dependencies
                working-directory: phpstan
                run: composer install --no-progress --prefer-dist --no-interaction

            -
                name: Run analyser
                working-directory: phpstan
                run: php ../analyser/bin/composer-dependency-analyser --config=build/composer-dependency-analyser.php

    shipmonk-rules:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
        steps:
            -
                name: Checkout code
                uses: actions/checkout@v4
                with:
                    path: analyser

            -
                name: Clone shipmonk/phpstan-rules
                uses: actions/checkout@v4
                with:
                    path: rules
                    repository: shipmonk-rnd/phpstan-rules

            -
                name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.3

            -
                name: Install analyser dependencies
                working-directory: analyser
                run: composer install --no-progress --prefer-dist --no-interaction

            -
                name: Install rules dependencies
                working-directory: rules
                run: composer install --no-progress --prefer-dist --no-interaction

            -
                name: Run analyser
                working-directory: rules
                run: php ../analyser/bin/composer-dependency-analyser
